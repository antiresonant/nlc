<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLC - Natural Language Compiler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        .input-panel, .output-panel {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }
        
        .input-panel {
            border-right: 2px solid #e0e0e0;
        }
        
        .panel-header {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .example-selector {
            margin-bottom: 15px;
        }
        
        .example-selector select {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }
        
        textarea {
            flex: 1;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            margin-bottom: 15px;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-section {
            margin-bottom: 15px;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .input-section input[type="text"],
        .input-section input[type="password"] {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .input-section small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        
        .checkbox-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .checkbox-section label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95em;
            color: #555;
        }
        
        .checkbox-section input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .api-key-section {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 4px;
        }
        
        .api-key-section.visible {
            display: block;
        }
        
        .compile-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .compile-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .compile-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .progress-status {
            margin-top: 10px;
            color: #666;
            font-size: 0.95em;
        }
        
        .output-area {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .output-area.success {
            border-left: 4px solid #10b981;
        }
        
        .output-area.error {
            border-left: 4px solid #ef4444;
            color: #dc2626;
        }
        
        .api-info {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #065f46;
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-panel {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 2px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ NLC Compiler</h1>
            <p>Write algorithms in plain English. Get working code. Like magic.</p>
        </div>
        
        <div class="main-content">
            <div class="input-panel">
                <div class="panel-header">üìù Your Algorithm</div>
                
                <div class="api-info">
                    ‚ú® <strong>Demo ready!</strong> Using author's API key. Start compiling immediately.
                </div>
                
                <div class="example-selector">
                    <select id="exampleSelect">
                        <option value="">-- Select an example --</option>
                        <option value="fibonacci">Fibonacci Calculator</option>
                        <option value="palindrome">Palindrome Checker</option>
                        <option value="prime">Prime Number Checker</option>
                        <option value="sort">List Sorter</option>
                        <option value="custom">Custom Algorithm</option>
                    </select>
                </div>
                
                <textarea id="algorithmInput" placeholder="BEGIN&#10;STEP 1: Describe what to do first&#10;STEP 2: Describe the next step&#10;STEP 3: Describe the final step&#10;END"></textarea>
                
                <div class="input-section">
                    <label for="testInput">Test Input (JSON format):</label>
                    <input type="text" id="testInput" placeholder='{"n": 10}' />
                </div>
                
                <div class="checkbox-section">
                    <label>
                        <input type="checkbox" id="useOwnKeyCheckbox" />
                        I want to use my own OpenAI API key
                    </label>
                    
                    <div class="api-key-section" id="apiKeySection">
                        <label for="apiKey" style="display: block; margin-bottom: 8px; font-weight: 600;">Your OpenAI API Key:</label>
                        <input type="password" id="apiKey" placeholder="sk-proj-..." style="width: 100%; padding: 10px; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 8px;" />
                        <small style="color: #92400e;">üîí Your key stays in your browser, never stored. Get one free at <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #b45309; font-weight: 600;">OpenAI Platform</a></small>
                    </div>
                </div>
                
                <button class="compile-btn" id="compileBtn">‚ö° Compile & Run</button>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                    <div class="progress-status" id="progressStatus">Initializing...</div>
                </div>
            </div>
            
            <div class="output-panel">
                <div class="panel-header">‚ú® Output</div>
                <div class="output-area" id="outputArea">Waiting for compilation...</div>
            </div>
        </div>
        
        <div class="footer">
            Built with OpenAI API ‚Ä¢ Powered by the NLC Framework
        </div>
    </div>

    <script>
        const examples = {
            fibonacci: {
                algorithm: `BEGIN
STEP 1: Take input number n
STEP 2: Calculate the nth Fibonacci number using iteration
STEP 3: Return the result
END`,
                input: '{"n": 10}'
            },
            palindrome: {
                algorithm: `BEGIN
STEP 1: Take input string text
STEP 2: Check if text reads the same forwards and backwards
STEP 3: Return true if palindrome, false otherwise
END`,
                input: '{"text": "racecar"}'
            },
            prime: {
                algorithm: `BEGIN
STEP 1: Take input number n
STEP 2: Check if n is divisible only by 1 and itself
STEP 3: Return true if prime, false otherwise
END`,
                input: '{"n": 17}'
            },
            sort: {
                algorithm: `BEGIN
STEP 1: Take input array of numbers
STEP 2: Sort the array in ascending order
STEP 3: Return the sorted array
END`,
                input: '{"numbers": [64, 34, 25, 12, 22, 11, 90]}'
            }
        };

        // Handle checkbox toggle
        document.getElementById('useOwnKeyCheckbox').addEventListener('change', (e) => {
            const apiKeySection = document.getElementById('apiKeySection');
            if (e.target.checked) {
                apiKeySection.classList.add('visible');
            } else {
                apiKeySection.classList.remove('visible');
            }
        });

        // Load saved API key from localStorage if available
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });

        document.getElementById('exampleSelect').addEventListener('change', (e) => {
            const example = examples[e.target.value];
            if (example) {
                document.getElementById('algorithmInput').value = example.algorithm;
                document.getElementById('testInput').value = example.input;
            } else {
                document.getElementById('algorithmInput').value = '';
                document.getElementById('testInput').value = '';
            }
        });

        document.getElementById('compileBtn').addEventListener('click', async () => {
            const algorithm = document.getElementById('algorithmInput').value.trim();
            const testInput = document.getElementById('testInput').value.trim();
            const useOwnKey = document.getElementById('useOwnKeyCheckbox').checked;
            let apiKey = null;
            
            if (!algorithm) {
                alert('Please enter an algorithm!');
                return;
            }
            
            if (useOwnKey) {
                apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    alert('Please enter your OpenAI API key or uncheck the box to use the demo key!');
                    return;
                }
                // Save API key to localStorage for convenience
                localStorage.setItem('openai_api_key', apiKey);
            }
            
            await compileAndRun(algorithm, testInput, apiKey);
        });

        async function compileAndRun(algorithm, testInput, userApiKey) {
            const btn = document.getElementById('compileBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const outputArea = document.getElementById('outputArea');
            
            btn.disabled = true;
            progressContainer.classList.add('active');
            outputArea.className = 'output-area';
            outputArea.textContent = '';
            
            try {
                // Parse test input
                let parsedInput = {};
                if (testInput) {
                    try {
                        parsedInput = JSON.parse(testInput);
                    } catch (e) {
                        throw new Error('Invalid JSON in test input');
                    }
                }
                
                // Step 1: Analyze algorithm
                updateProgress(20, 'Analyzing algorithm structure...');
                await sleep(500);
                
                // Step 2: Generate code with assertions
                updateProgress(40, 'Generating code with domain/range assertions...');
                const code = await generateCode(algorithm, userApiKey);
                await sleep(500);
                
                // Step 3: Verify assertions
                updateProgress(60, 'Verifying mathematical correctness...');
                await sleep(500);
                
                // Step 4: Execute code
                updateProgress(80, 'Executing compiled code...');
                const result = await executeCode(code, parsedInput);
                await sleep(300);
                
                // Step 5: Complete
                updateProgress(100, 'Compilation successful! ‚úì');
                await sleep(300);
                
                displaySuccess(code, result, parsedInput);
                
            } catch (error) {
                displayError(error.message);
            } finally {
                btn.disabled = false;
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    progressFill.style.width = '0%';
                }, 2000);
            }
        }

        async function generateCode(algorithm, userApiKey) {
            // If user provided their own key, use it directly
            if (userApiKey) {
                return await callOpenAI(algorithm, userApiKey);
            }
            
            // Otherwise, use Netlify Function with author's key
            try {
                const response = await fetch('/.netlify/functions/compile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ algorithm })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate code');
                }

                const data = await response.json();
                return data.code;
            } catch (error) {
                throw new Error(`Compilation error: ${error.message}`);
            }
        }

        async function callOpenAI(algorithm, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{
                        role: 'system',
                        content: 'You are the NLC (Natural Language Compiler). You convert algorithms into executable JavaScript code following the NLC framework with domain/range assertions. You return ONLY executable JavaScript code, no explanations, no markdown formatting.'
                    }, {
                        role: 'user',
                        content: `Convert this algorithm into executable JavaScript code following the NLC framework with domain/range assertions.

Algorithm:
${algorithm}

Requirements:
1. Parse the algorithm steps
2. Generate a single JavaScript function that implements ALL steps
3. The function MUST be named 'nlcCompiled'
4. Include proper error handling and type checking (domain assertions)
5. Return ONLY the function code, nothing else - no explanations, no markdown
6. The function should accept an object with named parameters
7. Make it production-ready and deterministic

Return ONLY the JavaScript function code with no formatting.`
                    }],
                    temperature: 0.1
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to generate code');
            }

            const data = await response.json();
            let code = data.choices[0].message.content;
            
            // Clean up any markdown formatting
            code = code.replace(/```javascript\n?/g, '').replace(/```\n?/g, '').trim();
            
            return code;
        }

        async function executeCode(code, input) {
            try {
                // Create a safe execution context
                const func = new Function('input', `
                    ${code}
                    return nlcCompiled(input);
                `);
                
                const result = func(input);
                return result;
            } catch (error) {
                throw new Error(`Execution error: ${error.message}`);
            }
        }

        function updateProgress(percent, status) {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            progressStatus.textContent = status;
        }

        function displaySuccess(code, result, input) {
            const outputArea = document.getElementById('outputArea');
            outputArea.className = 'output-area success';
            
            let output = '‚úì COMPILATION SUCCESSFUL\n\n';
            output += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            output += 'GENERATED CODE:\n';
            output += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            output += code;
            output += '\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            output += 'EXECUTION RESULT:\n';
            output += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            output += `Input: ${JSON.stringify(input, null, 2)}\n\n`;
            output += `Output: ${JSON.stringify(result, null, 2)}\n`;
            
            outputArea.textContent = output;
        }

        function displayError(message) {
            const outputArea = document.getElementById('outputArea');
            outputArea.className = 'output-area error';
            outputArea.textContent = `‚úó COMPILATION FAILED\n\n${message}`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
